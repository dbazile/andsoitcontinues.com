<!doctype html>
<html lang="en-us" class="__blog__">
<head>
  <meta charset="utf-8"/>
  <title>SOAP Opera | And So It Continues</title>
  <meta name="description" content="The following is an account of my adventures in manually parsing SOAP server responses without actually using SOAP."/>
  <meta name="viewport" content="width=device-width, initial-scale=0.7, minimum-scale=0.7"/>
  <base href="../"/>
  <link rel="icon" href="images/favicon.png"/>
  <link rel="apple-touch-icon" href="images/favicon.png"/>
  <link rel="stylesheet" type="text/css" href="styles/common.css"/>
  <link rel="stylesheet" type="text/css" href="styles/blog.css"/>
  <link rel="stylesheet" type="text/css" href="styles/highlighter.css"/>
  <link rel="stylesheet" type="text/css" href="styles/portfolio.css"/>
  <link rel="stylesheet" type="text/css" href="styles/about.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Hammersmith+One|Abhaya+Libre:400,700|Cormorant+Garamond:400i,700i|Anonymous+Pro:400,400i,700,700i">
  <script src="scripts/libhljs.js"></script>
  <script src="scripts/utils.js"></script>
  <script src="scripts/transitioner.js"></script>
</head>
<body>

  <header>
    <nav class="navigation">
      <svg viewBox="0 0 760 150" preserveAspectRatio="xMidYMin">
        <line x1="-3000" y1="140" x2="3000" y2="140" />
        <g class="navigation__item" transform="translate(0, 112), rotate(-45)">
          <a class="navigation__link navigation__link--blog" xlink:href="index.html">
            <circle cx="0" cy="40" r="6" />
            <path d="M0,40 l0,-40 l300,0 l0,40 z" />
            <text x="4" y="30">blog</text>
          </a>
        </g>
        <g class="navigation__item" transform="translate(75, 112), rotate(-45)">
          <a class="navigation__link navigation__link--portfolio" xlink:href="portfolio/index.html">
            <circle cx="0" cy="40" r="6" />
            <path d="M0,40 l0,-40 l300,0 l0,40 z" />
            <text x="4" y="30">portfolio</text>
          </a>
        </g>
        <g class="navigation__item" transform="translate(150, 112), rotate(-45)">
          <a class="navigation__link navigation__link--about" xlink:href="about.html">
            <circle cx="0" cy="40" r="6" />
            <path d="M0,40 l0,-40 l300,0 l0,40 z" />
            <text x="4" y="30">about</text>
          </a>
        </g>
        <a class="navigation__brand navigation__link" xlink:href="index.html">
          <g transform="translate(685, 88) scale(0.75)">
            <rect x="-5" y="-5" width="110" height="70" rx="20" />
            <path d="M48.361541,21.4785721 C49.5995624,21.5647052 52.1865138,21.7221366 53.9601115,21.6740356 L52.7250151,35.2830673 L48.7168154,34.0165864 L47.97067,36.1591957 L54.76234,38.4911427 L56.2416532,21.8947542 L57.9443369,28.0567191 L56.2924646,27.7733329 L55.8643707,29.0485707 L60.430706,29.8987287 L58.0285547,19.9783949 C62.1511986,17.3864329 68.192391,12.6797593 68.192391,12.6797593 C68.192391,12.6797593 64.9901324,10.7787296 61.806536,10.9837257 C58.9806297,11.1656962 52.0689189,16.6492921 50.5519,17.8788506 L50.5374543,17.7703046 C50.6653863,17.077182 50.5665284,16.4247429 50.2250378,15.8363752 C49.1332375,13.9551876 45.9305152,11.4314407 44.5135743,11.3355759 C44.4945643,11.334307 44.4749747,11.3336148 44.4539941,11.3336148 C43.6009781,11.3336148 41.1825344,12.5308286 39.3707881,13.5561548 C37.4499662,14.6430837 35.1918325,16.1100109 34.6144615,16.9671412 C34.1605031,17.641132 33.9258553,18.7543548 33.8607381,19.9111827 L30.4668926,20.3565091 L30.7660048,22.6040592 L33.9446517,22.1869703 C34.045398,22.9291024 34.2159195,23.5569088 34.4379235,23.9250089 C34.5277085,24.0738979 34.6239117,24.2151597 34.7263432,24.3486939 L32.4778126,25.2235273 L33.3107631,27.3343624 L37.0801073,25.8678276 C37.4901032,25.9683767 37.9307201,26.0193832 38.3991914,26.0193832 C40.2057215,26.0193832 42.4209667,25.2666544 44.8056792,23.8424107 C45.9882177,23.1360711 47.004069,22.4090892 47.8395519,21.6816619 L48.361541,21.4785721 Z" />
            <path d="M14.1313192,0 L20,0 L6.09487842,29.58154 L19.5061287,60.3718378 L13.5853707,60.3718378 L0,29.5123171 L14.1313192,0 Z" />
            <path d="M85.8686808,0 L80,0 L93.9051216,29.58154 L80.4938713,60.3718378 L86.4146293,60.3718378 L100,29.5123171 L85.8686808,0 Z" />
            <path d="M47.9336063,60.3718378 L42.119488,60.3718378 L74.494558,0 L80.2894861,0 L47.9336063,60.3718378 Z" />
            <path d="M20.998765,22.3161539 L26.5753271,31.8016347 L37.7968773,30.1169642 L38.0606663,32.9296577 L24.7787018,34.8732031 L18.5030355,23.3755282 L20.998765,22.3161539 Z" />
          </g>
        </a>
      </svg>
    </nav>
  </header>

  <main>
  <article class="post post--text">
    <div class="post__timestamp block">
      <span
        class="post__year">2013</span><span
        class="post__monthAndDate">12/05</span>
    </div>
    <h1 class="post__title block">SOAP Opera</h1>

    <section class="post__abstract block">
      <p>The following is an account of my adventures in manually parsing SOAP server responses without actually using SOAP.</p>
    </section>

    <section class="post__content">
      <blockquote>
<p>XML is like violence: if it doesn&rsquo;t solve your problem, you&rsquo;re not using enough of it.
<span class="quoth">xmlicious via <a href="http://thedailywtf.com/Comments/Oh,-XML.aspx#192304">thedailywtf</a></span></p>
</blockquote>
<h2>Background</h2>
<p>So, at work I&rsquo;m rewriting several data feed ingestion scripts from Perl to PHP, the majority of which contact remote servers via SOAP Web Services.  The problem is that while some of those web services return data that is pristine and concise, others are less than stellar.  Some contain namespaces and type definitions that yield a very predictable and well-defined data structure (i.e., arrays will appear where they should, whether only one element is there or ten).  Others seem to just be random, arbitrary and of questionable value.</p>
<p>Anyway, I am making good progress towards my goal and have a significant number of scripts converted.  Then I stumble upon a webservice whose authors have decided that they need to use upwards of 11 namespaces, that <em>everything</em> should be namespaced and that elements should contain children and attributes all of different namespaces.  It doesn&rsquo;t appear to add any value, structure or predictability to the overall data set.  Normally, nobody should ever have to worry about seeing this since SoapClient handles all of the unmarshalling anyway.  That was not to be the case this time.</p>
<h2>WSDL Shmisdle</h2>
<p>So, I point my SoapClient at their WSDL and attempt a pull.  I get a SOAP-ERROR complaining about not being able to load remote schema files (I forget the specific verbiage).  I look at the WSDL and sure enough, there are tags pointing to several <code>http://127.0.0.1:8080/some/path/to/file.xsd</code> schema files.  Obviously, we don&rsquo;t have those files because this is a remote web service, not our own.</p>
<p>One option is to pull the WSDL on each request, do a regular expression to change <code>127.0.0.1</code> to their domain, cache the file somewhere, then feed it to SoapClient hoping the URI is correct and won&rsquo;t change.  Not a fan of this since (a) I don&rsquo;t want to be dealing with any more XML than I need to, and (b) I have no idea how deep this error goes and have no desire to find out.  Would I have to fix the .XSD files the WSDL is pointing to if they are also broken?  No, please.</p>
<p>I then take a look at what the old script was doing.  Naturally, it&rsquo;s building a stringified SOAP Request and firing it off using Perl&rsquo;s <code>LWP::UserAgent</code>&hellip;  <em>le sigh</em>.</p>
<h2>Life in a post-SOAP world</h2>
<p>So, following in the footsteps of my predecessors, I string up this SOAP request manually, fire it off via CURL and get my XML string response.  Take the response string, pass it to <code>simplexml_load_string()</code> and <code>print_r()</code> the results, which was:</p>
<pre><code>SimpleXMLElement Object
    (
    )
</code></pre>
<p>Oh, a completely empty node.  WAT.</p>
<p>So as it turns out, SimpleXML (rightly) will hide anything namespaced at the current element and below.  Since the <code>&lt;soap:Envelope&gt;</code> node (i.e., the topmost node) of a SOAP response is namespaced, it and its children (i.e., everything we actually need) are hidden by default.  Not a problem &ndash; we can just register the <strong>soap</strong> namespace and <code>$xml-&gt;xpath('soap:Body/getFooBarResponse')</code>.  This works to get the body node, but since everything inside our current data response is a big bowl of namespace spaghetti with interwoven namespaces serving no apparent purpose other than obfuscation, we&rsquo;d need to know every node where the namespace changes and account for that with the proper &ldquo;peek&rdquo; operation.  With 4 different end points we need to hit for this particular web service, this could potentially be 4 * N special cases that need to be hardcoded into the script.  Further, this completely breaks the data adapter class we have in place for all other data sources, which assumes it&rsquo;s getting an object with a clean tree structure.</p>
<h2>A Workaround</h2>
<p>I did a bit more research at home and came up with this superhack of a workaround:</p>
<pre><code class="php">$namespaces = [
    'soap' =&gt; 'http://schemas.xmlsoap.org/soap/envelope/',
    'ns1' =&gt; 'com.andsoitcontinues.someentity',
    'ns2' =&gt; 'com.andsoitcontinues.someotherentity',
];

$dom = new DOMDocument();
$dom-&gt;loadXml($xml_string);

kill_the_namespaces($dom-&gt;childNodes, $namespaces);

function kill_the_namespaces(DOMNodeList $node_list, array $namespaces) {

    foreach ($node_list as $current_node) {
        if ($current_node instanceof DOMElement) {
            if ($current_node-&gt;hasChildNodes())
                kill_the_namespaces($current_node-&gt;childNodes, $namespaces);

            foreach ($namespaces as $local_name =&gt; $uri) {
                $current_node-&gt;removeAttributeNS($uri, $local_name);
            }
        }
    }
}
</code></pre>

<h2>Potential issues with this workaround</h2>
<p>I&rsquo;m well aware of the potential issues, which would include:</p>
<h3>1. Sibling nodes with the same name will become an array</h3>
<p>I am a firm believer in defensive programming, so I dereference all values from any SimpleXML structure using <code>strval()</code>, <code>intval()</code> or whatever data type I&rsquo;m expecting.  Invoking one of those methods on the <strong>foo</strong> property will yield the first element of the array anyway, which (should?) be okay for our purposes.</p>
<h4>Before:</h4>
<pre><code class="xml">&lt;ns1:foo&gt;alpha&lt;/ns1:foo&gt;
&lt;ns2:foo&gt;bravo&lt;/ns2:foo&gt;
&lt;ns3:foo&gt;charlie&lt;/ns3:foo&gt;
</code></pre>

<h4>After:</h4>
<pre><code class="xml">&lt;foo&gt;alpha&lt;/foo&gt;
&lt;foo&gt;bravo&lt;/foo&gt;
&lt;foo&gt;charlie&lt;/foo&gt;
</code></pre>

<h4>Which SimpleXML will parse as:</h4>
<pre><code>[foo] =&gt; Array
    (
        [0] =&gt; alpha
        [1] =&gt; bravo
        [2] =&gt; charlie
    )
</code></pre>
<h3>2. Clobbered attributes with bias toward descendants</h3>
<p>This one is a bit more serious than the aforementioned risk in that if it did happen, it would mask itself fairly well.  I don&rsquo;t foresee this being a huge issue for our current use case.</p>
<h4>Before:</h4>
<pre><code class="xml">&lt;foo ns1:somenum=&quot;111&quot; ns2:somenum=&quot;222&quot; ns3:somenum=&quot;333&quot;/&gt;
</code></pre>

<h4>After:</h4>
<pre><code class="xml">&lt;foo somenum=&quot;111&quot; somenum=&quot;222&quot; somenum=&quot;333&quot;/&gt;
</code></pre>

<h4>Which SimpleXML will parse as:</h4>
<pre><code>[foo] =&gt; Array
    (
        [@attributes] =&gt; Array
            (
                [somenum] =&gt; 333
            )
    )
</code></pre>
<h2>Conclusion</h2>
<p>I&rsquo;m not particularly proud of this workaround, but given the inability to affect the behavior of the proprietors of systems we request data from, you gotta do what you gotta do.</p>
<p>There&rsquo;s some good that came of this episode &ndash; I&rsquo;m learning a ton about XPath, XML Namespaces, the good, bad and the ugly of reading and writing SOAP encoding and a ton of other things.  I think I transcribed almost 100kb of XML by hand this week.  So, I&rsquo;ll mark this down as a learning experience.  Hopefully, I can write this code in a way that won&rsquo;t completely bewilder the next developer that has to touch it.</p>
<h6>Update 2013-12-02:</h6>
<p>I ended up not being able to use <code>kill_the_namespaces()</code> after all.  Unbeknownst to me, further down the execution chain there is a need to append nodes to the exact same structure to stage files for another system&rsquo;s ingestion.  If this was a read-only solution as I&rsquo;d originally assumed, I&rsquo;d be able to use the namespace remover and avoid having to put some even uglier code in this script, but alas no such luck for me (or the developer who is going to have to maintain this utility).</p>
<h3>Reference material:</h3>
<ol>
<li><a href="http://wanderingbarque.com/nonintersecting/2006/11/15/the-s-stands-for-simple/">The &ldquo;S&rdquo; Stands for Simple</a></li>
<li><a href="http://www.php.net/manual/en/domelement.removeattributens.php">DOMElement::removeAttributeNS()</a></li>
<li><a href="http://blog.preinheimer.com/index.php?/archives/172-SimpleXML,-Namespaces-Hair-loss.html">SimpleXML, Namespaces &amp; Hair loss</a></li>
</ol>
    </section>

    <section class="post__tags block">
      <h6>Tagged</h6>
      <ul>
        <li><a href="search.html?tagged=xml">xml</a></li>
        <li><a href="search.html?tagged=php">php</a></li>
        <li><a href="search.html?tagged=document object model">document object model</a></li>
        <li><a href="search.html?tagged=soap">soap</a></li>
      </ul>
    </section>
  </article>

  <script src="scripts/blogpost.js"></script>
  </main>

  <div class="scripts"></div>

  <div class="placeholders">
    <div class="placeholder placeholder--blog">
      <svg class="bookAndQull" viewBox="0 0 200 135" preserveAspectRatio="xMinYMin">
        <g class="bookAndQull__book">
          <g transform="translate(11.000000, 118.000000)">
            <path d="M178.285714,1.22222222 C178.285714,1.22222222 135.571429,3.66666667 113.285714,2.44444444 C101.273413,1.78565016 91,6.11111111 91,6.11111111 L91,6.72222222 C91,6.72222222 94.7142857,6.72222222 94.7142857,8.55555556 C98.4285714,8.55555556 99.3571429,6.11111111 99.3571429,6.11111111 L180.142857,6.11111103 L178.285714,1.22222222 Z M3.71428571,1.22222222 C3.71428571,1.22222222 46.4285714,3.66666667 68.7142857,2.44444444 C80.7265867,1.78565016 91,6.11111111 91,6.11111111 L91,6.72222222 C91,6.72222222 87.2857143,6.72222222 87.2857143,8.55555556 C83.5714286,8.55555556 82.6428571,6.11111111 82.6428571,6.11111111 L1.85714286,6.11111103 L3.71428571,1.22222222 Z" fill="#D8D8D8" />
            <path d="M0,6.11111111 L83.5714286,6.11111111 C85.4285714,6.11111111 85.4285714,8.61754635 87.2857143,8.55555556 C89.9074491,8.55555556 91.9285714,8.61754635 94.7142857,8.55555556 C96.5714286,8.61754635 96.5714286,6.11111111 98.4285714,6.11111111 L182,6.11111111 L182,8.61754645 L100.285714,8.61754635 C100.285714,8.61754635 98.4285714,11 96.5714286,11 C94.7142857,11 87.2857143,11 85.4285714,11 C83.5714286,11 81.7142857,8.61754645 81.7142857,8.61754645 L0,8.61754645 L0,6.11111111 Z" fill="#000000" />
            <path d="M174.571429,0.244440715 C174.571429,0.244440715 131.556114,1.0929764 116.241983,1.105141 C103.079923,1.11559613 91,5.20118881 91,5.20118881 L91,6.15121771 C91,6.15121771 102.69522,2.05914469 116.241983,2.04838398 C131.17141,2.03652496 176.428571,1.105141 176.428571,1.105141 L174.571429,0.244440715 Z M7.42857143,0.244440715 C7.42857143,0.244440715 50.4438863,1.0929764 65.7580175,1.105141 C78.9200767,1.11559613 91,5.20118881 91,5.20118881 L91,6.15121771 C91,6.15121771 79.30478,2.05914469 65.7580175,2.04838398 C50.8285896,2.03652496 5.57142857,1.105141 5.57142857,1.105141 L7.42857143,0.244440715 Z" fill="#D8D8D8" />
          </g>
        </g>
        <g class="bookAndQull__quill">
          <g transform="translate(111.000000, 39.000000)">
            <path d="M4.50000017,0.5 C5.00295876,0.500000001 5.9649475,1.07373114 7.09999847,2.19999981 C7.09966128,2.20702037 6.00000017,4.5 6.00000017,4.5 C6.00000017,4.5 7.43998197,2.56801981 7.52141647,2.65942058 C8.40172596,3.64746571 9.49999969,5.5 9.80000305,6.50000002 C10.0999985,7.5 10.4999997,9 10.4999997,9.5 C10.3026547,9.69734495 9.49999969,11 9.49999969,11 C9.49999969,11 10.4641492,10.6450549 10.8000031,9.5 C11.3744465,12.2913844 11.4376757,14.8339438 12,19 C12.1999969,21.2226134 12.4999997,32.5 12.8000031,34 C12.4999997,34.5 10.4999997,36.7000008 10.4999997,36.7000008 C10.4999997,36.7000008 11.9999997,35.5 12.6999969,34.7999992 C12.4999997,36 11.9999997,36.5 11.9999997,36.5 C11.9999997,36.5 12.4999997,36.5 12.9999997,36 C12.9999997,37.5 13.4000015,48 13.3000031,50 C13.3000031,53.1868603 12.6000064,55 12.3000031,56 C11.8000031,57 10.9999997,58.5 9.69999695,59.5 C10.2826011,59.1763315 11.9999997,58 12.9999997,56.5 C11.4999997,59.5 11.4999997,60.5 9.49999969,62.5 C9.54051366,62.6620558 11.4594857,60.8379442 11.4999997,61 C11.5690229,61.2760926 10.6046015,63.131214 9.49999969,64 C8.58573485,64.7190831 7.50000017,64.5 7.50000017,64.5 C7.50000017,64.5 8.00000017,65 10.4999997,64.5 C10.1582052,64.6708973 7.95987194,66 6.95987241,65.5 C6.86524688,65.5875955 8.99999969,67 8.99999969,68 C8.74852009,68 6.18823779,66.8106482 6.00000017,67 C6.40725004,67.2121375 7.25306024,67.9115057 7.50000017,68.5 C7.83508812,69.298564 7.50000017,70 7.50000017,70 C7.50000017,69 6.11820498,68 6.00000017,68 C6.50000017,69 6.50000017,70 6.50000017,70 C6.50000017,70 5.47322613,68.736613 5.00000017,68.5 C4.85915631,68.4295781 4.67754001,67.0102097 4.50000017,67 C4.01351824,66.9720241 3.99999993,69 3.99999993,69 C3.99999993,69 2.99999993,67.5 3.99999993,66.5 C2.99999993,66.5 2.00000005,65 2.00000005,65 C2.00000005,65 2.99999993,65.5 3.49999993,65.5 C2.49999993,65 1.50000005,63.2881091 1.50000005,63 C1.50000005,62.6910556 3.49999993,64.5 3.99999993,64.5 C2.49999993,63 2.49999993,63 2.00000005,62 C1.68303866,61.3660771 1.52452951,61 1.52452948,60.3529784 C2.49999993,61 2.99999993,61 2.99999993,61 C2.99999993,61 1.57269695,59.9445134 1.52452951,59.5 C0.999999989,57.9696884 0.602767455,51.1719538 0.5,48.5 C0.319426558,43.8050905 0.5,34 0.5,34 C0.5,34 0.923745095,24.3625202 1.52452951,16 C1.81129145,12.0084641 2.30220872,7.65650196 2.5,6 C3.11217652,0.873021678 3.50000017,0.499999998 4.50000017,0.5 Z" fill="#000000" />
            <path d="M3.34412179,6.97290924 C3.22691902,10.0104143 2.93767833,17.9190735 2.90808233,18.7633184 C2.65000082,26.1252588 2.5,31.3454798 2.5,33.5 C2.5,38.9442418 2.56231053,43.0442744 2.81298875,48.7096023 C3.1823706,57.0576322 3.87884263,64.4792075 5,73.0000035 C5,73.0000035 5.5,78.5 6,79 C6.5,79.0220794 7,74.0000035 7,74.0000035 C6,73.5 5.57130641,71.0701422 5.5,70.5000035 C4.51003381,62.5846148 4.15544512,56.4270031 3.81201125,48.6653977 C3.56211077,43.0176469 3.5,38.9307582 3.5,33.5 C3.5,31.3623538 3.64989747,26.1457298 3.90746843,18.7983531 C3.93705269,17.9544431 3.88282777,12.5367137 4,9.49999996 C4.0311289,8.69324259 4.00000002,2.9985316 4,1.99999996 C3.4632906,3.49853161 3.3851427,5.90978391 3.34412179,6.97290924 Z" fill="#7F7F7F" />
          </g>
        </g>
      </svg>
      <div class="placeholder__text">
        loading blog data
      </div>
    
      <style>
        .bookAndQull {}
    
        .bookAndQull__quill {
          animation: 3s infinite ease-in-out bookAndQuill__writingMotion;
        }
    
        @keyframes bookAndQuill__writingMotion {
          20% { transform: translateX(13px); }
          25% { transform: translateX( 8px); }
    
          30% { transform: translateX(23px); }
          35% { transform: translateX(18px); }
    
          40% { transform: translateX(36px); }
          45% { transform: translateX(31px); }
    
          50% { transform: translateX(49px); }
          55% { transform: translateX(44px); }
    
          60% { transform: translateX(65px); }
          80% { transform: translateX(65px); }
        }
      </style>
    </div>
  </div>

  <footer class="footer footer--standard block">
    <div class="footer__links">
      <a class="footer__link" href="https://github.com/dbazile" target="_blank" rel="nofollow"><img src="images/github-icon.svg" alt="My GitHub profile"/></a>
      <a class="footer__link" href="https://twitter.com/spoonchucks" target="_blank" rel="nofollow"><img src="images/twitter-icon.svg" alt="My Twitter profile"/></a>
      <a class="footer__link" href="https://instagram.com/spoonchucks" target="_blank" rel="nofollow"><img src="images/instagram-icon.svg" alt="My Instagram profile"/></a>
    </div>
    <p class="footer__copyright">&copy;2013-2016 David Bazile</p>
  </footer>
</body>
</html>